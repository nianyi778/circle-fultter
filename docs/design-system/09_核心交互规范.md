# Aura 拾光 · 核心交互规范

> 本文档定义产品中的核心交互模式，确保一致性和可预测性。
> 这些交互模式是用户体验的基础设施，必须严格遵循。

---

## 一、分页加载

### 1.1 设计原则

```
无感知的   用户不应该意识到"在加载下一页"
预加载的   提前加载，避免用户等待
平滑的     新内容自然融入，不打断浏览
容错的     失败时有优雅降级
```

### 1.2 触发时机

| 策略 | 描述 | 推荐场景 |
|------|------|---------|
| 距底触发 | 距离底部 N 像素时触发 | 默认推荐 |
| 可见触发 | 哨兵元素进入视口时触发 | 复杂布局 |
| 滚动结束 | 滚动停止后触发 | 性能敏感场景 |

**推荐配置**

```dart
触发距离: 距底部 200-300px（约 2-3 个列表项高度）
预加载数量: 每页 10-20 条
最大缓存: 保留最近 100 条，超出后释放最早的
```

### 1.3 加载状态

**加载中**

```dart
位置: 列表底部
样式: 小型加载指示器 + 可选文案
高度: 60px
动效: fadeIn, 200ms
```

```
┌─────────────────────────────────┐
│         [最后一条内容]          │
├─────────────────────────────────┤
│              ○                  │  ← 加载指示器
│         正在加载...             │  ← 可选文案
└─────────────────────────────────┘
```

**加载完成（无更多）**

```dart
位置: 列表底部
样式: 淡色文案
高度: 40px
```

```
文案选项:
✓ "已经到底了"
✓ "没有更多了"
✓ 无文案（留白）

✗ "No more data"
✗ "THE END"
```

**加载失败**

```dart
位置: 列表底部
样式: 错误提示 + 重试按钮
高度: 80px
```

```
┌─────────────────────────────────┐
│         [最后一条内容]          │
├─────────────────────────────────┤
│    加载失败，点击重试           │
│         [重试按钮]              │
└─────────────────────────────────┘
```

### 1.4 新内容入场

**动效规范**

```dart
每条新内容:
  - fadeIn + slideY(8px)
  - duration: 300ms
  - 交错延迟: 50ms
  - 最多交错 5 条（后续立即显示）
```

### 1.5 下拉刷新 + 分页

```dart
下拉刷新时:
  - 清空当前列表（或保留显示，后台刷新）
  - 重新加载第一页
  - 重置分页状态
  
推荐: 保留当前内容，刷新成功后替换
```

### 1.6 Flutter 实现示例

```dart
class PaginatedList extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final items = ref.watch(itemsProvider);
    final isLoadingMore = ref.watch(isLoadingMoreProvider);
    final hasMore = ref.watch(hasMoreProvider);
    
    return NotificationListener<ScrollNotification>(
      onNotification: (notification) {
        if (notification is ScrollEndNotification) {
          final metrics = notification.metrics;
          if (metrics.pixels >= metrics.maxScrollExtent - 200) {
            if (!isLoadingMore && hasMore) {
              ref.read(itemsProvider.notifier).loadMore();
            }
          }
        }
        return false;
      },
      child: ListView.builder(
        itemCount: items.length + (hasMore ? 1 : 0),
        itemBuilder: (context, index) {
          if (index == items.length) {
            return LoadingIndicator();
          }
          return ItemCard(item: items[index])
            .animate(delay: Duration(milliseconds: 50 * min(index, 5)))
            .fadeIn()
            .slideY(begin: 0.02);
        },
      ),
    );
  }
}
```

---

## 二、草稿自动保存

### 2.1 设计原则

```
静默的     用户不应该操心"保存"
即时的     输入立即保存，不丢失
可恢复的   意外关闭后能恢复
清晰的     用户知道草稿状态
```

### 2.2 保存策略

| 策略 | 触发时机 | 适用场景 |
|------|---------|---------|
| 防抖保存 | 停止输入 1-2 秒后 | 文本编辑（推荐） |
| 变化保存 | 每次内容变化 | 小数据量场景 |
| 定时保存 | 每 30 秒 | 大量数据场景 |
| 事件保存 | 特定事件（如添加图片） | 媒体操作 |

**推荐组合**

```dart
文本输入: 防抖 1.5s
媒体操作: 操作完成后立即
页面退出: 立即保存
应用切后台: 立即保存
```

### 2.3 草稿存储

**存储位置**

```dart
本地存储: SharedPreferences 或 SQLite
数据结构: 
{
  "id": "draft_moment_xxx",
  "content": "文本内容",
  "mediaIds": ["id1", "id2"],
  "contextTags": {...},
  "updatedAt": "2024-01-20T10:30:00Z",
  "type": "moment" // moment | letter
}
```

**存储时机**

```dart
// 伪代码
final _debouncer = Debouncer(milliseconds: 1500);

void onContentChanged(String content) {
  _debouncer.run(() {
    saveDraft(content);
  });
}

void onMediaAdded(List<Media> media) {
  saveDraft(currentContent, media: media); // 立即保存
}

@override
void dispose() {
  saveDraft(currentContent); // 退出时保存
  super.dispose();
}
```

### 2.4 草稿恢复

**恢复时机**

```dart
进入编辑页时:
  if (存在未发布草稿 && 草稿非空) {
    提示用户: "检测到未完成的内容，是否继续编辑？"
    按钮: "继续" / "放弃"
  }
```

**提示文案**

```
发布页:
  "上次的内容还在，要继续吗？"
  按钮: "继续编辑" / "重新开始"

信编辑页:
  "这封信还没写完呢"
  按钮: "继续写" / "重新开始"
```

### 2.5 草稿状态指示

**保存状态**

```dart
位置: 编辑页顶部或底部
样式: 小字 + 图标

状态文案:
  - 已保存: "已保存" (显示 2 秒后消失)
  - 保存中: "保存中..." (带小型指示器)
  - 保存失败: "保存失败，请检查存储空间" (持续显示)
```

**视觉设计**

```dart
字号: 12px
颜色: warmGray500
图标: 小勾/小云
动效: fadeIn/fadeOut, 200ms
```

### 2.6 草稿清理

**自动清理**

```dart
发布成功后: 立即删除对应草稿
草稿过期: 30 天未修改的草稿提示清理
用户主动放弃: 立即删除
```

**多草稿管理**

```dart
// 对于可能有多个草稿的场景（如多封信）
保留规则: 每种类型最多保留 5 个草稿
超出处理: 删除最旧的
```

---

## 三、撤销机制

### 3.1 设计原则

```
可逆的     危险操作提供反悔机会
及时的     撤销窗口足够但不过长
清晰的     用户知道可以撤销
非阻塞的   不打断用户流程
```

### 3.2 撤销类型

| 类型 | 适用场景 | 实现方式 |
|------|---------|---------|
| 软删除 + Toast 撤销 | 删除列表项 | 推荐 |
| 本地暂存 + 对话框撤销 | 编辑覆盖 | 数据敏感场景 |
| 操作历史栈 | 富文本编辑 | 复杂编辑场景 |

### 3.3 软删除撤销（推荐）

**流程设计**

```
1. 用户点击删除
2. UI 立即响应（元素消失动画）
3. 显示撤销 Toast（包含撤销按钮）
4. 后台启动删除计时（5-10 秒）
5. 计时结束 → 真正删除
   用户点击撤销 → 恢复元素
```

**视觉设计**

```dart
Toast 样式:
  内容: "已删除" + [撤销] 按钮
  时长: 5-10 秒（比普通 Toast 长）
  位置: 底部
  样式: 深色背景，撤销按钮高亮

元素消失动画:
  效果: slideX(-100%) + fadeOut
  时长: 200ms
  
元素恢复动画:
  效果: slideX(0) + fadeIn
  时长: 250ms
```

**实现示例**

```dart
class UndoableDelete {
  Timer? _deleteTimer;
  
  void deleteItem(String itemId, BuildContext context) {
    // 1. UI 立即响应
    ref.read(itemsProvider.notifier).hideItem(itemId);
    
    // 2. 显示撤销 Toast
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text('已删除'),
        action: SnackBarAction(
          label: '撤销',
          onPressed: () => _undoDelete(itemId),
        ),
        duration: Duration(seconds: 5),
      ),
    );
    
    // 3. 启动删除计时
    _deleteTimer = Timer(Duration(seconds: 5), () {
      _confirmDelete(itemId);
    });
  }
  
  void _undoDelete(String itemId) {
    _deleteTimer?.cancel();
    ref.read(itemsProvider.notifier).restoreItem(itemId);
  }
  
  void _confirmDelete(String itemId) {
    ref.read(itemsProvider.notifier).permanentlyDelete(itemId);
  }
}
```

### 3.4 不可撤销操作

以下操作不提供撤销：

| 操作 | 原因 | 替代方案 |
|------|------|---------|
| 封存信件 | 有意设计为不可逆 | 允许追加后记 |
| 发布到世界 | 可撤回但非撤销 | 提供撤回功能 |
| 账号注销 | 法规要求需确认 | 多次确认 + 冷静期 |

对于这些操作，使用**多次确认**代替撤销：

```
第一次确认: 说明后果
冷静期: 可选（如注销需等待 7 天）
```

---

## 四、确认对话框

### 4.1 使用原则

```
危险操作     必须确认
不可逆操作   必须确认 + 说明后果
重要操作     可选确认（如封存）
常规操作     不需要确认
```

### 4.2 确认层级

| 层级 | 适用场景 | 样式 |
|------|---------|------|
| 轻量确认 | 退出编辑、放弃草稿 | ActionSheet 或对话框 |
| 标准确认 | 删除单条内容 | 对话框 |
| 严重确认 | 删除全部、注销账号 | 对话框 + 二次验证 |

### 4.3 对话框设计

**参见 05_反馈系统.md - 确认对话框**

---

## 五、手势交互

### 5.1 滑动删除

**触发条件**

```dart
滑动方向: 从右向左（LTR 布局）
触发距离: 滑动超过元素宽度 30%
动效: 跟手滑动，释放后弹回或删除
```

**视觉设计**

```dart
滑动过程:
  - 元素跟手移动
  - 背景露出删除色区域
  - 删除图标渐显

触发删除:
  - 元素滑出 + fadeOut
  - 显示撤销 Toast

未触发（弹回）:
  - 弹性回弹
  - duration: 250ms
  - curve: gentle
```

### 5.2 长按操作

**触发时机**

```dart
触发时长: 500ms
反馈: 触发时轻微放大 + 触觉反馈
```

**操作菜单**

```dart
样式: 底部 ActionSheet 或上下文菜单
进入: 从底部滑入 或 从触点展开
选项: 图标 + 文字
```

**长按菜单选项示例（时间线卡片）**

```
- 编辑
- 分享到世界 / 从世界撤回
- 添加到年度信
- 删除
```

### 5.3 下滑关闭

**适用场景**

```
- 全屏详情页
- 全屏图片查看
- 模态页面
```

**触发条件**

```dart
滑动方向: 从上向下
触发距离: 下滑超过 100px 且速度 > 500px/s
            或 下滑超过屏幕高度 30%
```

**动效设计**

```dart
滑动过程:
  - 页面跟手下移
  - 背景渐显（遮罩变淡）
  - 页面可选缩放（scale: 1.0 → 0.9）

关闭动效:
  - 页面继续下滑出屏幕
  - fadeOut
  - duration: 200ms

取消（弹回）:
  - 弹回原位
  - duration: 250ms
  - curve: gentle
```

### 5.4 双击操作

**适用场景**

```
- 图片双击放大（图片查看器）
- 双击共鸣（可选，类似 Instagram）
```

**注意事项**

```
不应该: 双击作为唯一的操作方式
必须: 有替代的单击操作
```

---

## 六、表单交互

### 6.1 输入验证

**验证时机**

| 时机 | 适用场景 |
|------|---------|
| 失焦验证 | 必填校验、格式校验 |
| 实时验证 | 长度限制、禁用字符 |
| 提交验证 | 最终校验、关联校验 |

**错误显示**

```dart
位置: 输入框下方
时机: 失焦后或提交时
样式: 红色文字, 12px, fadeIn
```

### 6.2 输入辅助

**字数统计**

```dart
位置: 输入框右下角
显示: 当前字数 / 最大字数（可选）
颜色: 
  - 正常: warmGray400
  - 接近上限: warningMedium
  - 超出: dangerMedium
```

**输入引导**

```dart
Placeholder: 提供输入示例
辅助文字: 输入框下方说明（非错误时）
```

### 6.3 键盘处理

**键盘弹出**

```dart
处理方式: 
  - 推荐: resizeToAvoidBottomInset = true
  - 或: 手动滚动到可见区域

动效: 随键盘动画同步
```

**键盘收起**

```dart
触发方式:
  - 点击空白区域
  - 点击完成按钮
  - 向下滑动（可选）
```

---

## 七、导航交互

### 7.1 返回行为

**标准返回**

```dart
触发: 系统返回键、AppBar 返回按钮、下滑手势
行为: 返回上一页
无需确认: 无未保存内容时
```

**编辑页返回**

```dart
有未保存内容时:
  - 拦截返回
  - 显示确认对话框
  - 提供保存/放弃选项
```

### 7.2 Tab 切换

**底部导航**

```dart
切换方式: 点击切换（不支持滑动）
动效: 内容区域 fadeIn/fadeOut, 200ms
状态保持: 返回时保持之前的滚动位置
```

**顶部 Tab**

```dart
切换方式: 点击 或 滑动
动效: 内容区域横向滑动切换
```

### 7.3 深度链接

**支持场景**

```
- 通知跳转到具体内容
- 分享链接打开具体页面
- 外部链接进入
```

**处理原则**

```dart
有登录态: 直接跳转目标页
无登录态: 先登录，登录后跳转目标页
目标不存在: 显示错误页，提供返回首页
```

---

## 八、列表交互

### 8.1 下拉刷新

**参见 06_状态设计.md - 下拉刷新**

### 8.2 列表排序

**排序切换**

```dart
入口: 筛选按钮 或 排序下拉
选项: 最新优先 / 最早优先
动效: 列表 fadeOut → 新数据 fadeIn
```

### 8.3 多选操作

**进入多选**

```dart
触发: 长按单项 或 点击"选择"按钮
反馈: 出现选择框，底部出现操作栏
```

**多选操作栏**

```dart
位置: 屏幕底部（覆盖底部导航）
内容: 已选数量 + 操作按钮
操作: 删除 / 移动 / 分享
```

---

## 九、媒体交互

### 9.1 图片选择

**选择流程**

```dart
1. 点击添加图片按钮
2. 弹出选择器（相册/拍照）
3. 选择图片（支持多选）
4. 确认返回
5. 显示已选图片缩略图
```

**数量限制**

```dart
最大数量: 9 张
超出提示: Toast "最多选择 9 张图片"
```

### 9.2 图片查看

**查看模式**

```dart
进入: 点击图片
动效: 图片放大到全屏（Hero 动画）
功能: 双指缩放、滑动切换、下滑关闭
```

### 9.3 图片删除

**删除方式**

```dart
编辑时: 点击删除角标 或 长按拖拽到删除区域
确认: 无需确认（可撤销）
动效: 缩小 + fadeOut
```

---

## 十、交互一致性检查

设计/实现交互时，对照以下清单：

- [ ] 分页加载是否无感知？
- [ ] 草稿是否自动保存？
- [ ] 危险操作是否可撤销或有确认？
- [ ] 手势交互是否有触觉反馈？
- [ ] 表单验证是否及时且友好？
- [ ] 返回行为是否符合预期？
- [ ] 状态切换是否有过渡动画？

---

> **记住：**
> 交互的最高境界是"无感知"，
> 用户只感受到自然，而非"在操作"。
